<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>Unit Testing Inside Enterprise Microservices</title>
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preload" href="/assets/css/app.css?v=a878b22737" as="style" />
  <link rel="preload" href="/assets/js/manifest.js?v=a878b22737" as="script" />
  <link rel="preload" href="/assets/js/vendor/content-api.min.js?v=a878b22737" as="script" />
  <link rel="preload" href="/assets/js/vendor.js?v=a878b22737" as="script" />
  <link rel="preload" href="/assets/js/app.js?v=a878b22737" as="script" />
  <link rel="preconnect" href="https://polyfill.io">
  <link rel="dns-prefetch" href="https://polyfill.io">

  <link
    href="https://fonts.googleapis.com/css2?family=Alegreya+Sans+SC:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
    rel="stylesheet">
  <!-- configure Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Alegreya+Sans:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500&display=swap"
    rel="stylesheet">

    <link rel="preload" href="/assets/css/post.css?v=a878b22737" as="style" />
  <link rel="preload" href="/assets/js/post.js?v=a878b22737" as="script" />


  <style>
    /* These font-faces are here to make fonts work if the Ghost instance is installed in a subdirectory */

    /* iconmoon */
    @font-face {
      font-family: 'icomoon';
      font-weight: normal;
      font-style: normal;
      font-display: swap;
      src: url("/assets/fonts/icomoon/icomoon.eot?vukg2s?v=a878b22737");
      src: url("/assets/fonts/icomoon/icomoon.eot?vukg2s#iefix?v=a878b22737") format('embedded-opentype'),
      url("/assets/fonts/icomoon/icomoon.ttf?vukg2s?v=a878b22737") format('truetype'),
      url("/assets/fonts/icomoon/icomoon.woff?vukg2s?v=a878b22737") format('woff'),
      url("/assets/fonts/icomoon/icomoon.svg?vukg2s#icomoon?v=a878b22737") format('svg');
    }
  </style>

  <link rel="stylesheet" type="text/css" href="/assets/css/app.css?v=a878b22737" media="screen" />

    <link rel="stylesheet" type="text/css" href="/assets/css/post.css?v=a878b22737" media="screen" />


    <style>
    .m-hero__picture {
      background-image: url(https://images.unsplash.com/photo-1542744094-24638eff58bb?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ);
    }
  
    @media(max-width: 1000px) {
      .m-hero__picture {
        background-image: url(https://images.unsplash.com/photo-1542744094-24638eff58bb?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ);
      }
    }
  
    @media(max-width: 600px) {
      .m-hero__picture {
        background-image: url(https://images.unsplash.com/photo-1542744094-24638eff58bb?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ);
      }
    }
  </style>


  <link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://neighborlynook.com/unit-testing-inside-enterprise-microservices/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="https://neighborlynook.com/unit-testing-inside-enterprise-microservices/amp/" />
    
    <meta property="og:site_name" content="Neighborly Nook" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Unit Testing Inside Enterprise Microservices" />
    <meta property="og:description" content="Enterprise microservices tend to be a combination of technologies. The objective of this post is to go over multiple approaches to different scenarios commonly found in enterprise JS services. The Scenarios: Testing a service-call with an XML request to an enterprise SOAP serviceTesting a standard POST call to an enterprise" />
    <meta property="og:url" content="https://neighborlynook.com/unit-testing-inside-enterprise-microservices/" />
    <meta property="og:image" content="https://images.unsplash.com/photo-1542744094-24638eff58bb?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ" />
    <meta property="article:published_time" content="2020-10-25T23:09:46.000Z" />
    <meta property="article:modified_time" content="2020-10-25T23:09:46.000Z" />
    <meta property="article:tag" content="developer" />
    <meta property="article:tag" content="code" />
    <meta property="article:tag" content="webdev" />
    
    <meta property="article:publisher" content="https://www.facebook.com/ghost" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Unit Testing Inside Enterprise Microservices" />
    <meta name="twitter:description" content="Enterprise microservices tend to be a combination of technologies. The objective of this post is to go over multiple approaches to different scenarios commonly found in enterprise JS services. The Scenarios: Testing a service-call with an XML request to an enterprise SOAP serviceTesting a standard POST call to an enterprise" />
    <meta name="twitter:url" content="https://neighborlynook.com/unit-testing-inside-enterprise-microservices/" />
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1542744094-24638eff58bb?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Matthew Zygowicz" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="developer, code, webdev" />
    <meta name="twitter:site" content="@ghost" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="1333" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Neighborly Nook",
        "url": "https://neighborlynook.com/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://neighborlynook.com/content/images/2020/07/Youtube-logologo-yt.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Matthew Zygowicz",
        "image": {
            "@type": "ImageObject",
            "url": "https://neighborlynook.com/content/images/2020/07/me.png",
            "width": 512,
            "height": 512
        },
        "url": "https://neighborlynook.com/author/matthew/",
        "sameAs": [
            "http://neighborlynook.com"
        ]
    },
    "headline": "Unit Testing Inside Enterprise Microservices",
    "url": "https://neighborlynook.com/unit-testing-inside-enterprise-microservices/",
    "datePublished": "2020-10-25T23:09:46.000Z",
    "dateModified": "2020-10-25T23:09:46.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://images.unsplash.com/photo-1542744094-24638eff58bb?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ",
        "width": 2000,
        "height": 1333
    },
    "keywords": "developer, code, webdev",
    "description": "Enterprise microservices tend to be a combination of technologies. The objective\nof this post is to go over multiple approaches to different scenarios commonly\nfound in enterprise JS services.\n\nThe Scenarios:\n\n 1. Testing a service-call with an XML request to an enterprise SOAP service\n 2. Testing a standard POST call to an enterprise service\n 3. Testing a database connection and related queries\n 4. Testing an LDAP connection and related searches\n 5. Testing an express route containing one or mo",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://neighborlynook.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.36" />
    <link rel="alternate" type="application/rss+xml" title="Neighborly Nook" href="https://neighborlynook.com/rss/" />
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-174592801-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-174592801-1');
</script>


<!-- configure TOCBot --> 
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">
<style>
    .toc-link::before{
        display: none;
    }
</style>

<!-- Misc Styles --> 
<style>
</style>

<!-- prism.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" />
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/themes/prism-tomorrow.min.css" integrity="sha512-vswe+cgvic/XBoF1OcM/TeJ2FW0OofqAVdCZiEYkd6dwGXthvkSFWOoGGJgS2CW70VK5dQM5Oh+7ne47s74VTg==" crossorigin="anonymous" /> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" />
<style>
    .token.operator {
        background: 0 0;
    }
</style>

  <script>
    // @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
    const ghostHost = "https://neighborlynook.com"
      // @license-end
  </script>
</head>

<body class="post-template tag-developer tag-code tag-webdev">
  



  
<header class="m-header with-picture js-header">
  <div class="m-mobile-topbar" data-aos="fade-down">
    <button class="m-icon-button in-mobile-topbar js-open-menu" aria-label="Open menu">
      <span class="icon-menu" aria-hidden="true"></span>
    </button>
      <a href="https://neighborlynook.com" class="m-logo in-mobile-topbar">
        <img src="/content/images/2020/07/Youtube-logologo-yt.png" alt="Neighborly Nook">
      </a>
    <button class="m-icon-button in-mobile-topbar js-open-search" aria-label="Open search">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
  </div>

  <div class="m-menu js-menu">
    <button class="m-icon-button outlined as-close-menu js-close-menu" aria-label="Close menu">
      <span class="icon-close"></span>
    </button>
    <div class="m-menu__main" data-aos="fade-down">
      <div class="l-wrapper">
        <div class="m-nav">
          <nav class="m-nav__left" role="navigation" aria-label="Main menu">
            <ul>
                <li class="only-desktop">
                  <a href="https://neighborlynook.com" class="m-logo">
                    <img src="/content/images/2020/07/Youtube-logologo-yt.png" alt="Neighborly Nook">
                  </a>
                </li>
                
    <li class="nav-home">
      <a href="https://neighborlynook.com/">Home</a>
    </li>
    <li class="nav-authors">
      <a href="https://neighborlynook.com/authors/">Authors</a>
    </li>
    <li class="nav-tags">
      <a href="https://neighborlynook.com/tags/">Tags</a>
    </li>

              <li class="js-submenu-option">
                <button class="m-icon-button in-menu-main more js-toggle-submenu" aria-label="Open submenu">
                  <span class="icon-more" aria-hidden="true"></span>
                </button>
                <div class="m-submenu js-submenu">
                  <div class="l-wrapper in-submenu">
                    <section class="m-recent-articles">
                      <h3 class="m-submenu-title in-recent-articles">Recent articles</h3>
                          <div class="glide js-recent-slider">
                            <div class="glide__track" data-glide-el="track">
                              <div class="glide__slides">
                                <div class="glide__slide">
                                  <a href="/unit-testing-inside-enterprise-microservices/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="https://images.unsplash.com/photo-1542744094-24638eff58bb?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Unit Testing Inside Enterprise Microservices">
                                      Unit Testing Inside Enterprise Microservices
                                    </h3>
                                    <span class="m-recent-article__date">10 days ago</span>
                                  </a>
                                </div>
                                <div class="glide__slide">
                                  <a href="/recognizing-understanding-postpartum/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="https://images.unsplash.com/photo-1560305850-d90e0af2ff18?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Recognizing &amp; Understanding Postpartum">
                                      Recognizing &amp; Understanding Postpartum
                                    </h3>
                                    <span class="m-recent-article__date">2 months ago</span>
                                  </a>
                                </div>
                                <div class="glide__slide">
                                  <a href="/the-benefits-of-breastfeeding-vs-formula/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="https://images.unsplash.com/photo-1523881542461-305ab566932f?ixlib&#x3D;rb-1.2.1&amp;q&#x3D;80&amp;fm&#x3D;jpg&amp;crop&#x3D;entropy&amp;cs&#x3D;tinysrgb&amp;w&#x3D;2000&amp;fit&#x3D;max&amp;ixid&#x3D;eyJhcHBfaWQiOjExNzczfQ" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="The Benefits of Breastfeeding vs Formula">
                                      The Benefits of Breastfeeding vs Formula
                                    </h3>
                                    <span class="m-recent-article__date">3 months ago</span>
                                  </a>
                                </div>
                                <div class="glide__slide">
                                  <a href="/how-this-blog-was-made/" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="/content/images/size/w300/2020/08/taylor-vick-M5tzZtFCOfs-unsplash.jpg" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="How this blog was made">
                                      How this blog was made
                                    </h3>
                                    <span class="m-recent-article__date">3 months ago</span>
                                  </a>
                                </div>
                              </div>
                            </div>
                          </div>
                    </section>
                    <section class="m-tags">
                      <h3 class="m-submenu-title">Tags</h3>
                        <ul>
                            <li>
                              <a href="/tag/baby/">baby</a>
                            </li>
                            <li>
                              <a href="/tag/bottle-fed/">bottle fed</a>
                            </li>
                            <li>
                              <a href="/tag/breastfeeding/">breastfeeding</a>
                            </li>
                            <li>
                              <a href="/tag/code/">code</a>
                            </li>
                            <li>
                              <a href="/tag/developer/">developer</a>
                            </li>
                            <li>
                              <a href="/tag/enfamil/">Enfamil</a>
                            </li>
                            <li>
                              <a href="/tag/formula/">formula</a>
                            </li>
                            <li>
                              <a href="/tag/postpartum/">postpartum</a>
                            </li>
                            <li>
                              <a href="/tag/pregnancy/">pregnancy</a>
                            </li>
                            <li>
                              <a href="/tag/recipe/">recipe</a>
                            </li>
                        </ul>
                    </section>
                  </div>
                </div>
              </li>
            </ul>
          </nav>
          <div class="m-nav__right">
            <button class="m-icon-button in-menu-main js-open-search" aria-label="Open search">
              <span class="icon-search" aria-hidden="true"></span>
            </button>
            <div class="m-toggle-darkmode js-tooltip" data-tippy-content="Toggle dark mode" tabindex="0">
              <label for="toggle-darkmode" class="sr-only">
                Toggle dark mode
              </label>
              <input id="toggle-darkmode" type="checkbox" class="js-toggle-darkmode">
              <div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</header>

<main class="main-wrap">
    

  <section class="m-hero with-picture" data-aos="fade">
    <div class="m-hero__picture in-post"></div>
    </section>
  
  <article>
    <div class="l-content in-post">
        <div class="l-wrapper in-post  js-aos-wrapper" data-aos="fade-up"
          data-aos-delay="300">
          <div
            class="l-post-content   js-progress-content">
            <header class="m-heading">
              <h1 class="m-heading__title in-post">Unit Testing Inside Enterprise Microservices</h1>
              <div class="m-heading__meta">
                  <a href="https://neighborlynook.com/tag/developer/" class="m-heading__meta__tag">developer</a>
                  <span class="m-heading__meta__divider" aria-hidden="true">&bull;</span>
                <span class="m-heading__meta__time">Oct 25, 2020</span>
              </div>
            </header>
            <div class="pos-relative js-post-content">
              <div class="m-share">
                <div class="m-share__content js-sticky">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https://neighborlynook.com/unit-testing-inside-enterprise-microservices/"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Facebook">
                    <span class="icon-facebook" aria-hidden="true"></span>
                  </a>
                  <a href="https://twitter.com/intent/tweet?text=Unit%20Testing%20Inside%20Enterprise%20Microservices&url=https://neighborlynook.com/unit-testing-inside-enterprise-microservices/"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Twitter">
                    <span class="icon-twitter" aria-hidden="true"></span>
                  </a>
                  <button class="m-icon-button filled in-share progress js-scrolltop" aria-label="Scroll to top">
                    <span class="icon-arrow-top" aria-hidden="true"></span>
                    <svg aria-hidden="true">
                      <circle class="progress-ring__circle js-progress" fill="transparent" r="0" />
                    </svg>
                  </button>
                </div>
              </div>
              <p>Enterprise microservices tend to be a combination of technologies. The objective of this post is to go over multiple approaches to different scenarios commonly found in enterprise JS services.</p><p>The Scenarios:</p><ol><li>Testing a service-call with an XML request to an enterprise SOAP service</li><li>Testing a standard POST call to an enterprise service</li><li>Testing a database connection and related queries</li><li>Testing an LDAP connection and related searches</li><li>Testing an express route containing one or more of the above</li></ol><p>Before we get into the article, you can find most code samples inside this repo I threw together for this.</p><p>https://github.com/goldsziggy/enterprise-testing-patterns</p><h2 id="the-objective">The Objective</h2><p>The question remains, why perform unit-testing? Adding testing around your express-routes helps ensure your complete code path and tool-chain are being tested. Proper code coverage guarantees your calls are still being invoked and the business logic needed is unhindered. This gives developers confidence when updating dependencies and allows for more automation and less human intervention.</p><p>What this post is NOT.  This post is not a great example of how to write an enterprise express service.  The repo I link here does not do any input scrubbing and is written purely for example purposes and to show-case testing patterns in a semi-real environment.</p><h2 id="the-toolchain">The Toolchain</h2><p>To accomplish the above testing we will leverage the following toolchain/stack:</p><ul><li><a href="https://jestjs.io/">Jest</a> - This will be our test-runner and overall framework. We will leverage Jest mocks when it comes time to test MySQL and LDAP responses</li><li><a href="https://github.com/nock/nock">Nock</a> - A delightfully simple HTTP mocking library. This will be leveraged whenever we need to mock an outbound connection (REST/SOAP)</li><li><a href="https://www.npmjs.com/package/supertest">SuperTest</a> - A HTTP library leveraged for testing express app servers.</li></ul><h2 id="testing-a-service-call-with-an-xml-request-to-an-enterprise-soap-service">Testing a service-call with an XML request to an enterprise SOAP service</h2><p><code>https://github.com/goldsziggy/enterprise-testing-patterns/blob/master/__tests__/soap.spec.js</code></p><p>When building unit tests around network-based requests such as SOAP, we generally don't care about the transport layer. That means, our testing goal should be verifying our request before it's sent, and how our service behaves after the request.</p><p>With that said, we can start examing the test-cases written for this example.</p><h3 id="the-imports">The Imports</h3><pre><code class="language-js">const nock = require('nock') // HTTP Mocking library
const parser = require('fast-xml-parser') // XML parser
const lodash = require('lodash') 
const { currencyConversion } = require('../src/soap') // the sample soap service call
</code></pre><p><code>nock</code> and <code>fast-xml-parser</code> in my opinion are must-haves.  As I mentioned previously we don't care about the HTTP transport layer, so we can rely on nock to mock that piece out of the equation to make our test-cases consistent and accurate.  <code>fast-xml-parser</code> will be used to confirm the request XML we generate meets certain business requirements.</p><h3 id="sample-responses">Sample responses</h3><pre><code class="language-js">const sampleSuccessResponse = `&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;
  &lt;soap:Body&gt;
    &lt;GetCurrencyRateResponse xmlns="http://tempuri.org/"&gt;
      &lt;GetCurrencyRateResult&gt;15&lt;/GetCurrencyRateResult&gt;
    &lt;/GetCurrencyRateResponse&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;`

const sampleErrorResponse = `&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;&lt;soap:Body&gt;&lt;soap:Fault&gt;&lt;faultcode&gt;soap:Client&lt;/faultcode&gt;&lt;faultstring&gt;Server was unable to read request. ---&amp;gt; There is an error in XML document (12, 18). ---&amp;gt; The string \'1603068090810\n      \' is not a valid AllXsd value.&lt;/faultstring&gt;&lt;detail /&gt;&lt;/soap:Fault&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;`
</code></pre><p>Soap responses are generally more verbose than REST responses, with varying XML tags being used in the response. It is for that reason I recommend storing these responses in a variable.  In this example, I hard-coded strings to the top of the file, but as a better practice, I would make these responses live in the folder with the soap request.</p><h3 id="test-type-1-happy-path">Test-Type 1: Happy Path</h3><pre><code class="language-js">it('Should return the currency upon success', async (done) =&gt; {
  nock(soapURL).post('/converter.asmx?WSDL').reply(200, sampleSuccessResponse)
  const val = await currencyConversion(Date.now(), false)
  expect(val).toEqual(15)
  done()
})
</code></pre><p>The happy path testing is always the smallest of the tests. Here we simply call out function and rely on nock to reply with our consistent sampleSuccessResposne.  Following the <code>nock</code> API, we specify the baseURL for our soap service and tell nock to force a reply with 200 success-code and our sample success response.</p><h3 id="test-type-2-verify-dynamic-requests">Test-Type 2: Verify Dynamic Requests</h3><pre><code class="language-js">it('Should set currency to US when isUSD is true', async (done) =&gt; {
  let isCurrencySetAndCorrect = false
  nock(soapURL)
    .post(`/converter.asmx?WSDL`)
    .reply(200, (uri, requestBody) =&gt; {
      const parsed = parser.parse(requestBody)
      const parsedRate = lodash.get(parsed, 'soap:Envelope.soap:Body.GetCurrencyRate')
      isCurrencySetAndCorrect = parsedRate.Currency === 'US'
    })
  await currencyConversion(Date.now(), true)
  expect(isCurrencySetAndCorrect).toEqual(true)
  done()
})
</code></pre><p>In our sample enterprise service, our soap requesting function will build an XML string based on a dynamic template.  The above test, confirms the correctness of the dynamically generated XML.  To do this, we leverage nock's ability to apply introspection on the requestBody.  You will notice we don't put our expect statement within the nock mock, we separate it like this because if the URL is never called the expect would never be called to error out our test properly.</p><h3 id="test-type-3-the-expected-error-case">Test-Type 3: The Expected Error Case</h3><pre><code class="language-js">it('Should throw the soap Error when there is XML returned', async (done) =&gt; {
  nock(soapURL).post('/converter.asmx?WSDL').reply(500, sampleErrorResponse)
  try {
    await currencyConversion(Date.now(), false)
  } catch (e) {
    expect(e.message).toEqual(expect.stringContaining('Server was unable to read request'))
    return done()
  }
  done(new Error('expected the soap call to throw an error and none was recieved'))
})
</code></pre><p>The above test case shows us forcing a 500 response with our expected <code>errorResponseXML</code> object. The logic within our sample service is designed to create a new error with the proper message derived from our XML object.  This test ensures that our expected error message exists.</p><h2 id="testing-a-standard-post-call-to-an-enterprise-service">Testing a standard POST call to an enterprise service</h2><p><code>https://github.com/goldsziggy/enterprise-testing-patterns/blob/master/__tests__/services.spec.js</code></p><p>Writing test cases to individual services can be a valuable task - at times.  My philosophy here is that rest service calls should be simple concise functions with little functionality.  These small functions will create a lot of 'boilerplate' looking tests.</p><h3 id="the-imports-1">The Imports</h3><pre><code class="language-js">const nock = require('nock')
const services = require('../src/services')
</code></pre><p>For testing our small service calls we simply require our <code>nock</code> library once again.  We will leverage this library to mock successes, failures, and timeouts all without making the network request.  Below, we will simply leverage the nock function in different ways to enable us to create/cause errors</p><h3 id="test-case-1-the-happy-path">Test-Case 1: The Happy Path</h3><pre><code class="language-js">it('Should return the data on a successful call', async (done) =&gt; {
  const id = '123'
  const mockData = { foo: 'bar' }
  nock('https://ghibliapi.herokuapp.com').get(`/films/${id}`).reply(200, mockData)
  const data = await services.getByFilmId(id, { info: jest.fn(), error: jest.fn() })
  expect(data).toEqual(mockData)
  done()
})
</code></pre><p>Paying attention to the line with the service call, you will notice us leverage jest mocks.  In this example, our service is passed a child logger of Bunyan that is used to log out.  Because we are not in the middle of our express call stack, we have to mock the implementation of that object to not cause errors</p><h3 id="test-case-2-the-expected-failure">Test-Case 2: The Expected Failure</h3><pre><code class="language-js">it('Should throw an error when the service is down', async (done) =&gt; {
  const id = '123'
  nock('https://ghibliapi.herokuapp.com')
    .get(`/films/${id}`)
    .reply(500, () =&gt; {})
  try {
    await services.getByFilmId(id, { info: jest.fn(), error: jest.fn() })
    throw new Error('The service call did not throw the expected error')
  } catch (e) {
    expect(e.message).toEqual('Request failed with status code 500')
  }
  done()
})
</code></pre><h3 id="test-case-3-the-timeout-behavior">Test-Case 3: The timeout behavior</h3><pre><code class="language-js">it('Should throw an error if the service call timesout', async (done) =&gt; {
  const id = '123'
  nock('https://ghibliapi.herokuapp.com')
    .get(`/films/${id}`)
    .delayConnection(1500)
    .reply(200, {})
  try {
    await services.getByFilmId(id, { info: jest.fn(), error: jest.fn() })
    throw new Error('The service call did not throw the expected error')
  } catch (e) {
    expect(e.message).toEqual('timeout of 1000ms exceeded')
  }
  done()
})
</code></pre><h2 id="testing-a-database-connection-and-related-queries">Testing a database connection and related queries</h2><p>As developers testing implementation code there is no need to call the underlying database.  In these scenarios we can rely on Jest mocks to become our imaginary database connection.  This way we have full control over the output and they can properly wargame both success and error scenarios.</p><h3 id="the-setup">The Setup</h3><p>When building out database connections I recommend having a single file to prep and export our database client. Our service can then leverage this file throughout for usage creating a single point where our requests originate simplifying testing.</p><pre><code class="language-js">const mysql = require('mysql2')

const pool = mysql.createPool({
  host: process.env.MYSQL_HOST || 'example.org',
  user: process.env.MYSQL_USER || 'bob',
  password: process.env.MYSQL_PW || 'secret',
  database: process.env.MYSQL_DB || 'test',
})

module.exports = pool.promise()
</code></pre><h3 id="mocking-and-testing">Mocking and Testing</h3><p><code>https://github.com/goldsziggy/enterprise-testing-patterns/blob/master/__tests__/mysql.spec.js</code></p><pre><code class="language-js">const mockPool = require('../src/mysql/connection')

jest.mock('../src/mysql/connection', () =&gt; {
  return {
    query: jest.fn(),
  }
})
</code></pre><p>With our implementation code being the exported pool connection, we can create our mock of the object and the query function.  By completing the above, we are allowed to freely manipulate the <code>mockPool</code> and fake our return results for our test-cases.</p><pre><code class="language-js">it('Should run the query from inputOne', async (done) =&gt; {
  mockPool.query.mockImplementation((sql) =&gt; {
    // place your mock data here for testing more complex returns!
    return [1, 2]
  })

  await querySomething(true)

  expect(mockPool.query).toHaveBeenCalledWith('SELECT * FROM inputOne WHERE 1=1')
  done()
})
</code></pre><p>In this sample test, we tell our <code>mockPool</code> to return a mocked-up array.  Following the data setup, we then call our functional logic in <code>querySomething</code>.  With the above setup complete we can validate what the SQL query was.  Taking this a step further, if our <code>querySomething</code> function performed additional business logic or data manipulation we could confirm the output of the function via an expect clause as well.</p><h2 id="testing-an-ldap-connection-and-related-searches">Testing an LDAP connection and related searches</h2><p>Mocking up LDAP will follow the same pattern as the MySQL example above.  We will create a file to act as our intermediary for all LDAP connections/queries - and use that for our mocks.  When interacting with LDAP I prefer the <code>ldapts</code> package as it does come promisified.</p><pre><code class="language-js">const { Client } = require('ldapts')

const url = 'ldaps://ldap.jumpcloud.com'

const client = new Client({
  url,
})

return client
</code></pre><h3 id="mocking-and-testing-1">Mocking and Testing</h3><pre><code class="language-js">const { getUsers } = require('../src/ldap/ldap-calls')
const mockLdap = require('../src/ldap/client')

jest.mock('../src/ldap/client', () =&gt; {
  return {
    bind: jest.fn(),
    unbind: jest.fn(),
    search: jest.fn(),
  }
})

...

afterEach(() =&gt; {
  mockLdap.search.mockReset()
  mockLdap.bind.mockReset()
  mockLdap.unbind.mockReset()
})
</code></pre><p>From the above, you will notice the same pattern used in the MySQL section.  We take our singleton-like client object and prep it to be used as a mock. Different from the MySQL implementation, you will notice we perform a cleanup <code>afterEach</code> of our test runs.  Cleanup functions like this are a great practice to help ensure your mocks aren't causing side-effects and creating flaky tests.</p><pre><code class="language-js"> it('When LDAP succeeds should return the searchEntries, and call unbind', async (done) =&gt; {
  mockLdap.search.mockImplementation(() =&gt; {
    // place your mock data here for testing more complex returns!
    return { searchEntries: 'matt@zygowicz.com' }
  })
  try {
    const user = await getUsers('foo')
    expect(user).toEqual('matt@zygowicz.com')
    expect(mockLdap.bind).toHaveBeenCalled()
    expect(mockLdap.search).toHaveBeenCalled()
    expect(mockLdap.unbind).toHaveBeenCalled()
  } catch (e) {
    done(e)
  }
  done()
})
</code></pre><p>The above test case shows us creating a mock implementation of our search function.  This mock simply returns a hard-coded entry.  This allows us to confirm the logic in our code base for when success or failure happens.   Additionally, I confirm that our LDAP connection was unbound and closed after the call as well.</p><h2 id="testing-an-express-route-containing-one-or-more-of-the-above">Testing an express route containing one or more of the above</h2><p>Finally, now that we have tested all the individual pieces, we need to confirm that our logic that binds them is accurate.  For this section, we will take the lessons learned from above, and mock out a single route from our microservice.</p><pre><code class="language-js">// same scaffolding we've seen before
...
  it("should call getAllFilms, taking the first result and passing it to getFilmById", (done) =&gt; {
    const mockItem = { id: "321" };
    mockLdap.search.mockImplementation(() =&gt; {
      return { searchEntries: "matt@zygowicz.com" };
    });
    nock("https://ghibliapi.herokuapp.com")
      .get(`/films`)
      .reply(200, [mockItem, { id: "123" }]);
    nock("https://ghibliapi.herokuapp.com")
      .get(`/films/${mockItem.id}`)
      .reply(200, mockItem);
    request(app)
      .post("/enterprise-testing-patterns")
      .expect(200)
      .end((err, res) =&gt; {
        if (err) {
          done(err);
        }
        expect(res.body).toEqual({
          film: { id: "321" },
          user: "matt@zygowicz.com",
        });
        done();
      });
  });
</code></pre><p>From top to bottom of this test, you'll notice it is quite concise.  A majority of the test will be mocking out the individual components down the stack that the route will use.  The benefit of this test is that it creates an end-to-end view of how all the components integrate</p><p>In my opinion, these types of tests are the most valuable, as generally speaking the route is where a majority of the business rules around how to manipulate the data you are retrieving live.  These tests are not without their faults though; as the scale of the test increase, the chances of you introducing human-induced flakiness increase.</p>
                <section class="m-tags in-post">
                  <h3 class="m-submenu-title">Tags</h3>
                  <ul>
                      <li>
                        <a href="/tag/developer/" title="developer">developer</a>
                      </li>
                      <li>
                        <a href="/tag/code/" title="code">code</a>
                      </li>
                      <li>
                        <a href="/tag/webdev/" title="webdev">webdev</a>
                      </li>
                  </ul>
                </section>
            </div>
          </div>
        </div>
        <section class="m-author">
          <div class="m-author__content">
            <div class="m-author__picture">
              <a href="https://neighborlynook.com/author/matthew/" class="m-author-picture" aria-label="Matthew Zygowicz">
                  <div style="background-image: url(https://neighborlynook.com/content/images/2020/07/me.png);"></div>
              </a>
            </div>
            <div class="m-author__info">
              <h4 class="m-author__name">
                <a href="https://neighborlynook.com/author/matthew/">Matthew Zygowicz</a>
              </h4>
                <p class="m-author__bio">The dad of the family.  I am a Senior Engineer by trade at Northwestern Mutual working on the Login/Registration team.</p>
              <ul class="m-author-links">
                  <li>
                    <a href="http://neighborlynook.com" target="_blank" rel="noopener" aria-label="Website">
                      <span class="icon-globe" aria-hidden="true"></span>
                    </a>
                  </li>
              </ul>
            </div>
          </div>
        </section>
        <section class="m-recommended">
          <div class="l-wrapper in-recommended">
            <h3 class="m-section-title in-recommended">Recommended for you</h3>
            <div class="m-recommended-articles">
              <div class="m-recommended-slider glide js-recommended-slider">
                <div class="glide__track" data-glide-el="track">
                  <div class="glide__slides">
                    
    <div class="m-recommended-slider__item glide__slide">
  <article class="m-article-card  post tag-developer tag-code tag-webdev">
    <div class="m-article-card__picture">
      <a href="/how-this-blog-was-made/" class="m-article-card__picture-link" aria-hidden="true" tabindex="-1"></a>
        <img class="m-article-card__picture-background" src="/content/images/size/w600/2020/08/taylor-vick-M5tzZtFCOfs-unsplash.jpg" loading="lazy" alt="">
      <a href="https://neighborlynook.com/author/matthew/" class="m-article-card__author js-tooltip" aria-label="Matthew Zygowicz" data-tippy-content="Posted by Matthew Zygowicz ">
          <div style="background-image: url(/content/images/size/w100/2020/07/me.png);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="https://neighborlynook.com/tag/developer/" class="m-article-card__tag">developer</a>
      <a href="/how-this-blog-was-made/" class="m-article-card__info-link" aria-label="How this blog was made">
        <div>
          <h2 class="m-article-card__title js-article-card-title " title="How this blog was made">
            How this blog was made
          </h2>
        </div>
        <div class="m-article-card__timestamp">
          <span>3 months ago</span>
          <span>&bull;</span>
          <span>4 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
                  </div>
                </div>
                <div data-glide-el="controls" class="glide__arrows js-controls">
                  <button data-glide-dir="<" class="m-icon-button filled in-recommended-articles glide-prev" aria-label="Previous">
                    <span class="icon-arrow-left" aria-hidden="true"></span>
                  </button>
                  <button data-glide-dir=">" class="m-icon-button filled in-recommended-articles glide-next" aria-label="Next">
                    <span class="icon-arrow-right" aria-hidden="true"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
    </div>
  </article>
</main>



  
<div class="m-search js-search" role="dialog" aria-modal="true" aria-label="Search">
  <button class="m-icon-button outlined as-close-search js-close-search" aria-label="Close search">
    <span class="icon-close" aria-hidden="true"></span>
  </button>
  <div class="m-search__content">
    <form class="m-search__form">
      <div class="pos-relative">
        <span class="icon-search m-search-icon" aria-hidden="true"></span>
        <label for="search-input" class="sr-only">
          Type to search
        </label>
        <input id="search-input" type="text" class="m-input in-search js-input-search" placeholder="Type to search">
      </div>
    </form>
    <div class="js-search-results hide"></div>
    <p class="m-not-found align-center hide js-no-results">
      No results for your search, please try with something else.
    </p>
  </div>
</div>

  
<footer class="m-footer">
  <div class="m-footer__content">
    <p class="m-footer-copyright">
      <span>Neighborly Nook &copy; 2020</span>
      <span>&nbsp; &bull; &nbsp;</span>
      <span>Published with <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a></span>
    </p>

    <nav class="m-footer-social">
        <a href="https://www.facebook.com/ghost" target="_blank" rel="noopener" aria-label="Facebook">
          <span class="icon-facebook"></span>
        </a>
        <a href="https://twitter.com/ghost" target="_blank" rel="noopener" aria-label="Twitter">
          <span class="icon-twitter"></span>
        </a>
    </nav>
    <p class="m-footer-copyright jslicense">
      <a href="/assets/html/javascript.html?v=a878b22737" rel="jslicense">JavaScript license information</a>
    </p>
  </div>
</footer>

  <div class="m-alert success subscribe js-alert" data-notification="subscribe">
  Great! You&#x27;ve successfully subscribed.
  <button class="m-alert__close js-notification-close" aria-label="Close">
    <span class="icon-close"></span>
  </button>
</div>

<div class="m-alert success signup js-alert" data-notification="signup">
  Great! Next, complete checkout for full access.
  <button class="m-alert__close js-notification-close" aria-label="Close">
    <span class="icon-close"></span>
  </button>
</div>

<div class="m-alert success signin js-alert" data-notification="signin">
  Welcome back! You&#x27;ve successfully signed in.
  <button class="m-alert__close js-notification-close" aria-label="Close">
    <span class="icon-close"></span>
  </button>
</div>

<div class="m-alert success checkout js-alert" data-notification="checkout">
  Success! Your account is fully activated, you now have access to all content.
  <button class="m-alert__close js-notification-close" aria-label="Close">
    <span class="icon-close"></span>
  </button>
</div>
  <script crossorigin="anonymous"
    src="https://polyfill.io/v3/polyfill.min.js?features=IntersectionObserver%2CPromise%2CArray.prototype.includes%2CString.prototype.endsWith%2CString.prototype.startsWith%2CObject.assign%2CNodeList.prototype.forEach"></script>
  <script defer src="/assets/js/manifest.js?v=a878b22737"></script>
  <script defer src="/assets/js/vendor/content-api.min.js?v=a878b22737"></script>
  <script defer src="/assets/js/vendor.js?v=a878b22737"></script>
  <script defer src="/assets/js/app.js?v=a878b22737"></script>

    <script defer src="/assets/js/post.js?v=a878b22737"></script>


  <!-- configure TOCBot --> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script>
    tocbot.init({
        tocSelector: '.toc',
        contentSelector: '.post-content',
        hasInnerContainers: false
    });
</script>

<!-- prism.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/prism.min.js" integrity="sha512-WkVkkoB31AoI9DAk6SEEEyacH9etQXKUov4JRRuM1Y681VsTq7jYgrRw06cbP6Io7kPsKx+tLFpH/HXZSZ2YEQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/components/prism-markup.min.js" integrity="sha512-n7jTZRfbcHJ8Nwq9QmPPuEdScPL4Uti1yfvA/iA237hYf/XIOntX2JSiOjOpuPX/lOanojimXQZKu3L3MM763w==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/components/prism-css.min.js" integrity="sha512-zDjwO/e5eVa5WfYra8CE827RFyA/nqhp8y4da+geEpAqpCnmfAHopCNobQ9sJeLBMQY0OLB+hT+k6bbb0FhdYQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/components/prism-javascript.min.js" integrity="sha512-bcEaqkUmZaRn/mfetUNsz6y4SxOcc+eEqXOzWYWeXfSUS9mt1C/12fBAxT99mKcA1U1tIw6O9o17+AGqQ3Wmtg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/components/prism-bash.min.js" integrity="sha512-undB7JF5cHZkHEnrvpIR6vpLG/3YR5LeDjvGKMDvr5WD7U6Xrkhymp8asv7ausEICQorcKjq3BIjz0vI5yJCnA==" crossorigin="anonymous"></script>
</body>

</html>